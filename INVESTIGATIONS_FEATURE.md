# Investigations Feature - Chart Database Search

## Overview

The Investigations feature allows users to search through the famous charts database using natural language queries via the AI chatbot. Users can find charts based on astrological criteria like planetary positions, signs, houses, aspects, and categories.

## How It Works

### 1. Natural Language Query
User asks the chatbot a question like:
- "Find all charts with Moon in Pisces"
- "Show me musicians with Venus in the 10th house"
- "Which presidents have Mars in Capricorn?"
- "Find charts with Sun conjunct Uranus"

### 2. AI Understanding
Claude (the AI) recognizes this is a database search request and uses the `search_famous_charts` tool to execute the query.

### 3. Search Execution
The backend:
- Loads the `famousChartsCalculated.json` database (395 pre-calculated charts)
- Filters charts based on the structured criteria
- Returns matching results

### 4. Results Presentation
Claude formats the results conversationally and presents them to the user with:
- Number of matches found
- Chart names and categories
- Birth details and locations
- What criteria matched for each chart

## Supported Search Criteria

### Planet in Sign
Find charts where a specific planet is in a specific zodiac sign.

**Examples:**
- "Find charts with Moon in Pisces"
- "Show me Sun in Leo charts"
- "Which charts have Mercury in Gemini?"

**Supported planets:** Sun, Moon, Mercury, Venus, Mars, Jupiter, Saturn, Uranus, Neptune, Pluto, North Node, South Node

**Supported signs:** All 12 zodiac signs

### Planet in House
Find charts where a planet is in a specific house (requires accurate birth time).

**Examples:**
- "Find charts with Venus in the 10th house"
- "Show me Mars in 7th house"
- "Which charts have Saturn in the 1st house?"

**Note:** Only works for charts with accurate birth times (Rodden Rating AA, A, or B)

### Ascendant/Rising Sign
Find charts with a specific ascendant sign.

**Examples:**
- "Find Virgo rising charts"
- "Show me all Scorpio ascendants"
- "Which charts have Aquarius rising?"

### Aspects Between Planets
Find charts with specific aspects between two planets.

**Examples:**
- "Find charts with Sun conjunct Uranus"
- "Show me Moon trine Neptune"
- "Which charts have Mars square Pluto?"
- "Find Sun conjunct Uranus within 3 degrees" (tight orb)

**Supported aspects:** Conjunction, Opposition, Square, Trine, Sextile

### Category/Tags
Filter by category or occupation.

**Examples:**
- "Find musicians with Moon in Pisces"
- "Show me presidents with Mars in Capricorn"
- "Which scientists have Aquarius rising?"

**Common categories:** Musicians, Politicians, Scientists, Artists, Writers, Actors, Athletes, etc.

### Combined Criteria (AND Logic)
Mix multiple criteria together.

**Examples:**
- "Find charts with Sun in Leo AND Moon in Gemini"
- "Show me musicians with Venus in the 10th house AND Libra rising"
- "Which presidents have Mars in Capricorn and Sun conjunct Mercury?"

## Technical Implementation

### Components Created

1. **`src/shared/utils/chartSearch.js`** - Search utility
   - Core filtering logic
   - Criteria matching functions
   - Result formatting

2. **Updated `src/main/main.js`** - Backend integration
   - Added `search_famous_charts` tool to Claude API
   - Loads calculated charts database
   - Executes searches and returns results
   - Multi-turn conversation handling

### Architecture

```
User Query
    ↓
Claude AI (recognizes investigation)
    ↓
Calls search_famous_charts tool
    ↓
Main process loads famousChartsCalculated.json
    ↓
chartSearch.js filters database
    ↓
Results returned to Claude
    ↓
Claude formats and presents results
    ↓
User sees formatted results
```

### Database Requirements

The feature requires `famousChartsCalculated.json` to exist with pre-calculated chart data. This file is generated by running:

```bash
npm run calculate-database
```

## Example Queries and Expected Behavior

### Simple Sign Search
```
User: "Find all charts with Moon in Pisces"

Expected: Claude will search and return charts where Moon is in Pisces,
showing names, categories, and birth details.
```

### Multiple Criteria
```
User: "Show me musicians with Venus in the 10th house"

Expected: Claude will filter for:
- Category includes "musician"
- Venus in house 10
Returns matching charts with details.
```

### Aspect Search
```
User: "Which presidents have Sun conjunct Uranus?"

Expected: Claude will filter for:
- Category includes "president"
- Sun-Uranus conjunction aspect exists
Returns matching charts.
```

### Tight Orb Search
```
User: "Find charts with Sun conjunct Uranus within 3 degrees"

Expected: Claude will filter for:
- Sun-Uranus conjunction
- Orb ≤ 3 degrees
Returns charts with tight orbs only.
```

## Error Handling

### No Results Found
If no charts match the criteria, Claude will:
- Inform the user no matches were found
- Suggest trying different criteria or broader search

### Ambiguous Query
If the query is unclear, Claude may:
- Ask for clarification
- Suggest more specific criteria
- Offer examples

### Database Not Found
If `famousChartsCalculated.json` doesn't exist:
- Error message: "Failed to load charts database"
- User should run: `npm run calculate-database`

## Limitations

1. **Birth Time Dependency**
   - House positions require accurate birth times
   - Charts with uncertain times (Rodden Rating C/D) won't match house criteria
   - Angles (Ascendant, MC) also require accurate times

2. **Database Size**
   - Currently searches ~395 calculated charts
   - Ancient figures (BCE) not included due to ephemeris limitations

3. **Search Precision**
   - Category matching is text-based (may include partial matches)
   - Aspect matching uses pre-calculated aspects only (not dynamic calculation)

## Future Enhancements

Potential additions (not yet implemented):
- Transit-based investigations ("When will Saturn transit my 7th house?")
- Statistical analysis ("What's the most common Moon sign among musicians?")
- Chart comparison queries ("Find charts similar to mine")
- Custom orb settings per aspect type
- Save/export search results
- Load chart from search results (clickable)

## Testing

To test the feature:

1. Ensure database is calculated:
   ```bash
   npm run calculate-database
   ```

2. Start the app:
   ```bash
   npm run dev
   ```

3. Open the chat panel and try queries:
   - "Find charts with Moon in Pisces"
   - "Show me musicians with Venus in 10th house"
   - "Which presidents have Mars in Capricorn?"

4. Verify:
   - Search executes without errors
   - Results match the criteria
   - Results are formatted clearly
   - Number of matches is reasonable

## Console Logging

When a search executes, you'll see:
```
Claude used search_famous_charts tool with criteria: {...}
Search found X results
```

This helps debug what criteria Claude extracted and how many results were found.
